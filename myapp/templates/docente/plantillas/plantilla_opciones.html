<!-- plantillas/plantilla_opciones.html - COMPLETA CON BOTONES ELIMINAR -->
<div class="opciones-container">
    <label class="form-label fw-bold">
        <i class="fas fa-list me-2 text-success"></i>
        Opciones de respuesta
    </label>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        {% if pregunta.tipo.nombre == 'opcion_unica' %}
        Los estudiantes podr√°n seleccionar <strong>una sola</strong> opci√≥n como respuesta correcta.
        {% elif pregunta.tipo.nombre == 'opcion_multiple' %}
        Los estudiantes podr√°n seleccionar <strong>m√∫ltiples</strong> opciones como respuestas correctas.
        {% elif pregunta.tipo.nombre == 'falso_verdadero' %}
        Los estudiantes elegir√°n entre <strong>Verdadero</strong> o <strong>Falso</strong>.
        {% endif %}
    </div>
    
    <!-- Lista de opciones existentes -->
    <div class="opciones-lista" id="opciones-lista-{{ pregunta.id }}">
        {% for opcion in pregunta.opciones.all %}
        <div class="opcion-container {% if opcion.es_correcta %}opcion-correcta{% endif %}" 
             data-opcion-id="{{ opcion.id }}">
            
            <!-- Radio button o checkbox seg√∫n el tipo -->
            {% if pregunta.tipo.nombre == 'opcion_unica' or pregunta.tipo.nombre == 'falso_verdadero' %}
            <input type="radio" 
                   class="form-check-input opcion-radio" 
                   name="correcta_{{ pregunta.id }}" 
                   id="opcion_{{ opcion.id }}"
                   {% if opcion.es_correcta %}checked{% endif %}
                   onchange="manejarCambioOpcionCorrecta(this)"
                   data-opcion-id="{{ opcion.id }}"
                   data-pregunta-id="{{ pregunta.id }}">
            {% else %}
            <input type="checkbox" 
                   class="form-check-input opcion-checkbox" 
                   id="opcion_{{ opcion.id }}"
                   {% if opcion.es_correcta %}checked{% endif %}
                   onchange="manejarCambioOpcionCorrecta(this)"
                   data-opcion-id="{{ opcion.id }}"
                   data-pregunta-id="{{ pregunta.id }}">
            {% endif %}
            
            <!-- Input para el texto de la opci√≥n -->
            <input type="text" 
                   class="form-control opcion-input" 
                   value="{{ opcion.texto }}"
                   placeholder="Escriba el texto de la opci√≥n..."
                   data-opcion-id="{{ opcion.id }}"
                   data-field="texto_opcion"
                   onchange="actualizarTextoOpcion(this)">
            
            <!-- Bot√≥n eliminar opci√≥n -->
            {% if pregunta.opciones.count > 2 %}
            <button type="button" 
                    class="btn btn-eliminar-opcion" 
                    title="Eliminar esta opci√≥n"
                    data-opcion-id="{{ opcion.id }}"
                    onclick="eliminarOpcionExistente(this)">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
        {% empty %}
        <!-- Si no hay opciones, mostrar mensaje -->
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No hay opciones definidas para esta pregunta. 
            <button type="button" class="btn btn-sm btn-primary ms-2" onclick="agregarOpcionExistente(this)">
                <i class="fas fa-plus me-1"></i>Agregar primera opci√≥n
            </button>
        </div>
        {% endfor %}
    </div>
    
    <!-- Bot√≥n agregar nueva opci√≥n -->
    {% if pregunta.tipo.nombre != 'falso_verdadero' %}
    <div class="agregar-opcion-container mt-3">
        <button type="button" 
                class="btn-agregar-opcion" 
                title="Agregar nueva opci√≥n"
                data-pregunta-id="{{ pregunta.id }}"
                onclick="agregarOpcionExistente(this)">
            <i class="fas fa-plus"></i>
        </button>
        <span class="ms-2 text-muted">Agregar nueva opci√≥n</span>
    </div>
    {% endif %}
    
    <!-- Informaci√≥n sobre la respuesta correcta -->
    <div class="respuesta-info mt-3">
        <small class="text-muted">
            <i class="fas fa-lightbulb me-1"></i>
            {% if pregunta.tipo.nombre == 'opcion_unica' %}
            Marque la opci√≥n que ser√° la respuesta correcta.
            {% elif pregunta.tipo.nombre == 'opcion_multiple' %}
            Marque todas las opciones que ser√°n correctas (puede ser m√°s de una).
            {% elif pregunta.tipo.nombre == 'falso_verdadero' %}
            Marque si la afirmaci√≥n es verdadera o falsa.
            {% endif %}
        </small>
    </div>
</div>

<!-- Estilos espec√≠ficos para opciones -->
<style>
.opciones-container {
    background-color: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
}

.opciones-lista {
    margin: 15px 0;
}

.opcion-container {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    gap: 15px;
    padding: 18px;
    border-radius: 10px;
    transition: all 0.3s ease;
    border: 2px solid #f8f9fa;
    background-color: #ffffff;
    position: relative;
}

.opcion-container.opcion-correcta {
    background: linear-gradient(135deg, #d5f4e6 0%, #e8f5e8 100%);
    border: 2px solid #27ae60;
    border-left: 5px solid #27ae60;
}

.opcion-container:not(.opcion-correcta) {
    background-color: #fafbfc;
    border: 2px solid #e9ecef;
}

.opcion-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-color: #3498db;
}

.opcion-input {
    flex: 1;
    font-size: 1.05rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px 15px;
    transition: all 0.3s ease;
}

.opcion-input:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.15rem rgba(52,152,219,0.15);
    outline: none;
}

/* Radio buttons y checkboxes m√°s grandes */
.opcion-container input[type="radio"],
.opcion-container input[type="checkbox"] {
    transform: scale(1.4);
    margin-right: 8px;
    accent-color: #27ae60;
}

/* Bot√≥n agregar opci√≥n */
.btn-agregar-opcion {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    border: 2px dashed #3498db;
    background: transparent;
    color: #3498db;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-agregar-opcion:hover {
    background-color: #3498db;
    color: white;
    transform: scale(1.1);
    border-style: solid;
}

.agregar-opcion-container {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

.agregar-opcion-container:hover {
    border-color: #3498db;
    background-color: #e3f2fd;
}

/* Bot√≥n eliminar opci√≥n */
.btn-eliminar-opcion {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-eliminar-opcion:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
}

.btn-eliminar-opcion:active {
    transform: scale(0.95);
}

/* Informaci√≥n de respuesta */
.respuesta-info {
    background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%);
    border-left: 4px solid #3498db;
    padding: 12px 15px;
    border-radius: 6px;
}

/* Responsive */
@media (max-width: 768px) {
    .opcion-container {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
    }
    
    .opcion-container input[type="radio"],
    .opcion-container input[type="checkbox"] {
        transform: scale(1.2);
        margin-bottom: 8px;
    }
    
    .btn-eliminar-opcion {
        align-self: flex-end;
        margin-top: 8px;
    }
    
    .agregar-opcion-container {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
}
</style>

<!-- JavaScript para funcionalidad de opciones -->
<script>
// Funci√≥n para manejar cambio de opci√≥n correcta
function manejarCambioOpcionCorrecta(element) {
    const opcionId = element.dataset.opcionId;
    const preguntaId = element.dataset.preguntaId;
    const esCorrecta = element.checked;
    
    console.log(`üîò Cambiando opci√≥n ${opcionId} a ${esCorrecta ? 'correcta' : 'incorrecta'}`);
    
    // Actualizar estilos visuales inmediatamente
    const container = element.closest('.opcion-container');
    if (container) {
        if (esCorrecta) {
            container.classList.add('opcion-correcta');
        } else {
            container.classList.remove('opcion-correcta');
        }
    }
    
    // Para radio buttons, quitar la clase de otros contenedores
    if (element.type === 'radio') {
        const preguntaElement = element.closest('[data-pregunta-id]');
        if (preguntaElement) {
            preguntaElement.querySelectorAll('.opcion-container').forEach(cont => {
                if (cont !== container) {
                    cont.classList.remove('opcion-correcta');
                }
            });
        }
    }
    
    // Enviar actualizaci√≥n al servidor
    actualizarOpcionEnServidor(opcionId, element.closest('.opcion-input').value, esCorrecta);
}

// Funci√≥n para actualizar texto de opci√≥n
function actualizarTextoOpcion(element) {
    const opcionId = element.dataset.opcionId;
    const nuevoTexto = element.value.trim();
    
    if (!nuevoTexto) {
        mostrarAdvertencia('El texto de la opci√≥n no puede estar vac√≠o');
        return;
    }
    
    console.log(`‚úèÔ∏è Actualizando texto de opci√≥n ${opcionId}: ${nuevoTexto}`);
    
    // Verificar si la opci√≥n est√° marcada como correcta
    const container = element.closest('.opcion-container');
    const checkbox = container.querySelector('input[type="checkbox"], input[type="radio"]');
    const esCorrecta = checkbox ? checkbox.checked : false;
    
    // Enviar actualizaci√≥n al servidor
    actualizarOpcionEnServidor(opcionId, nuevoTexto, esCorrecta);
}

// Funci√≥n para enviar actualizaci√≥n al servidor
function actualizarOpcionEnServidor(opcionId, texto, esCorrecta) {
    fetch('/docente/cuestionario/actualizar-opcion/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            opcion_id: opcionId,
            texto: texto,
            es_correcta: esCorrecta
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ Opci√≥n ${opcionId} actualizada correctamente`);
        } else {
            console.error(`‚ùå Error al actualizar opci√≥n ${opcionId}:`, data.error);
            mostrarError('Error: ' + (data.error || 'Error al actualizar la opci√≥n'));
        }
    })
    .catch(error => {
        console.error('‚ùå Error de conexi√≥n al actualizar opci√≥n:', error);
        mostrarError('Error de conexi√≥n al actualizar la opci√≥n');
    });
}

// Funci√≥n para agregar opci√≥n
function agregarOpcionExistente(element) {
    const preguntaId = obtenerPreguntaId(element);
    if (!preguntaId) {
        mostrarError('No se pudo obtener el ID de pregunta');
        return;
    }
    
    console.log(`‚ûï Agregando opci√≥n a pregunta ${preguntaId}`);
    
    const loadingToast = mostrarCargando('Agregando opci√≥n...');
    
    fetch('/docente/cuestionario/agregar-opcion/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            pregunta_id: preguntaId
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingToast.hide();
        if (data.success) {
            console.log(`‚úÖ Opci√≥n agregada exitosamente a pregunta ${preguntaId}`);
            // Guardar estado del acorde√≥n
            sessionStorage.setItem('acordeonAbierto', `collapse${preguntaId}`);
            // Recargar p√°gina
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            console.error("‚ùå Error agregar opci√≥n:", data.error);
            mostrarError('Error: ' + (data.error || 'Error al agregar la opci√≥n'));
        }
    })
    .catch(error => {
        loadingToast.hide();
        console.error('‚ùå Error de conexi√≥n agregar opci√≥n:', error);
        mostrarError('Error de conexi√≥n al agregar la opci√≥n');
    });
}

// Funci√≥n para eliminar opci√≥n
function eliminarOpcionExistente(element) {
    const opcionId = element.dataset.opcionId;
    
    if (!opcionId) {
        mostrarError('No se pudo obtener el ID de opci√≥n');
        return;
    }
    
    console.log(`üóëÔ∏è Eliminando opci√≥n ${opcionId}`);
    
    mostrarConfirmacionElegante(
        'Eliminar Opci√≥n',
        '¬øEst√°s seguro de que quieres eliminar esta opci√≥n? Esta acci√≥n no se puede deshacer.',
        function() {
            const loadingToast = mostrarCargando('Eliminando opci√≥n...');
            
            fetch(`/docente/cuestionario/eliminar-opcion/${opcionId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                loadingToast.hide();
                if (data.success) {
                    mostrarExito('Opci√≥n eliminada exitosamente');
                    console.log(`‚úÖ Opci√≥n ${opcionId} eliminada exitosamente`);
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    console.error(`‚ùå Error al eliminar opci√≥n ${opcionId}:`, data.error);
                    mostrarError('Error: ' + (data.error || 'Error al eliminar la opci√≥n'));
                }
            })
            .catch(error => {
                loadingToast.hide();
                console.error('‚ùå Error de conexi√≥n al eliminar opci√≥n:', error);
                mostrarError('Error de conexi√≥n al eliminar la opci√≥n');
            });
        }
    );
}

// Funciones de utilidad (fallbacks si no est√°n definidas globalmente)
function obtenerPreguntaId(element) {
    let current = element;
    while (current && current !== document) {
        if (current.dataset && current.dataset.preguntaId) {
            return current.dataset.preguntaId;
        }
        
        if (current.getAttribute && current.getAttribute('data-pregunta-id')) {
            return current.getAttribute('data-pregunta-id');
        }
        
        if (current.id) {
            const match = current.id.match(/_(\d+)$/);
            if (match) {
                return match[1];
            }
        }
        
        const preguntaParent = current.closest('[data-pregunta-id]');
        if (preguntaParent) {
            return preguntaParent.dataset.preguntaId;
        }
        
        current = current.parentElement;
    }
    
    console.warn("‚ö†Ô∏è No se pudo obtener el ID de pregunta desde:", element);
    return null;
}

function getCookie(name) {
    // Usar funci√≥n global si existe
    if (typeof window.crearCuestionario !== 'undefined' && 
        typeof window.crearCuestionario.getCookie === 'function') {
        return window.crearCuestionario.getCookie(name);
    }
    
    // Fallback local
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function mostrarError(mensaje) {
    // Usar funci√≥n global si existe
    if (typeof window.crearCuestionario !== 'undefined' && 
        typeof window.crearCuestionario.mostrarError === 'function') {
        window.crearCuestionario.mostrarError(mensaje);
    } else {
        console.error('‚ùå ' + mensaje);
        alert('Error: ' + mensaje);
    }
}

function mostrarExito(mensaje) {
    // Usar funci√≥n global si existe
    if (typeof window.crearCuestionario !== 'undefined' && 
        typeof window.crearCuestionario.mostrarExito === 'function') {
        window.crearCuestionario.mostrarExito(mensaje);
    } else {
        console.log('‚úÖ ' + mensaje);
    }
}

function mostrarAdvertencia(mensaje) {
    // Usar funci√≥n global si existe
    if (typeof window.crearCuestionario !== 'undefined' && 
        typeof window.crearCuestionario.mostrarInfo === 'function') {
        window.crearCuestionario.mostrarInfo(mensaje);
    } else {
        console.warn('‚ö†Ô∏è ' + mensaje);
        alert('Advertencia: ' + mensaje);
    }
}

function mostrarCargando(mensaje) {
    // Usar funci√≥n global si existe
    if (typeof window.crearCuestionario !== 'undefined' && 
        typeof window.crearCuestionario.mostrarCargando === 'function') {
        return window.crearCuestionario.mostrarCargando(mensaje);
    } else {
        console.log('‚è≥ ' + mensaje);
        return { hide: () => {} };
    }
}

function mostrarConfirmacionElegante(titulo, mensaje, callback) {
    // Usar funci√≥n global si existe
    if (typeof window.crearCuestionario !== 'undefined' && 
        typeof window.crearCuestionario.mostrarConfirmacion === 'function') {
        window.crearCuestionario.mostrarConfirmacion(titulo, mensaje, callback);
    } else {
        if (confirm(mensaje)) {
            callback();
        }
    }
}

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar estilos correctos al cargar la p√°gina
    document.querySelectorAll('.opcion-container').forEach(container => {
        const radio = container.querySelector('input[type="radio"], input[type="checkbox"]');
        if (radio && radio.checked) {
            container.classList.add('opcion-correcta');
        } else {
            container.classList.remove('opcion-correcta');
        }
    });
    
    console.log('‚úÖ Plantilla opciones inicializada');
});
</script>