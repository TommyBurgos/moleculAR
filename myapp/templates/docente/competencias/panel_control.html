<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <title>Panel de Control - {{ competencia.recurso.titulo }}</title>
    
    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'assets/images/favicon.ico' %}">
    
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap">
    
    <!-- Plugins CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'assets/vendor/font-awesome/css/all.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}">
    
    <!-- Theme CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/style.css' %}">
    
    <!-- Panel Control CSS -->
    <style>
        /* =====================================================
        PANEL DE CONTROL - ESTILOS PRINCIPALES
        ===================================================== */

        /* Variables CSS */
        :root {
            --primary-color: #e74c3c;
            --primary-dark: #c0392b;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --white: #ffffff;
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-card: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
            
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.15);
            
            --border-radius: 12px;
            --border-radius-lg: 20px;
            --border-radius-xl: 25px;
            
            --transition: all 0.3s ease;
        }

        /* ===== LAYOUT BASE ===== */
        .panel-body {
            background: var(--gradient-primary);
            font-family: 'Heebo', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .page-content-wrapper {
            background: none;
            border: none;
        }

        /* ===== HEADER DEL PANEL ===== */
        .panel-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-md);
            padding: 2rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--primary-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .competition-info {
            flex: 1;
            min-width: 0;
        }

        .competition-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-icon {
            background: var(--gradient-primary);
            color: var(--white);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }

        .title-text h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
            line-height: 1.2;
        }

        .title-text p {
            color: #7f8c8d;
            margin: 0.5rem 0 0 0;
            font-size: 0.95rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        /* ===== PIN CONTAINER ===== */
        .pin-container {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .pin-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .pin-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .pin-code {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 8px;
            margin: 0.5rem 0;
            cursor: pointer;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .pin-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            position: relative;
            z-index: 2;
        }

        .btn-pin {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-pin:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        /* ===== STATUS BADGE ===== */
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-xl);
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: var(--shadow-md);
        }

        .status-configuracion {
            background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
            color: #2d3436;
            border: 3px solid var(--warning-color);
        }

        .status-esperando {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: var(--white);
            border: 3px solid #0984e3;
            animation: pulse-waiting 2s infinite;
        }

        .status-activa {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: var(--white);
            border: 3px solid #00b894;
            animation: pulse-active 1.5s infinite;
        }

        .status-pausada {
            background: linear-gradient(45deg, #fd79a8, #e84393);
            color: var(--white);
            border: 3px solid #e84393;
            animation: pulse-paused 2s infinite;
        }

        .status-finalizada {
            background: linear-gradient(45deg, #636e72, #2d3436);
            color: var(--white);
            border: 3px solid #636e72;
        }

        @keyframes pulse-waiting {
            0% { box-shadow: 0 0 0 0 rgba(9, 132, 227, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(9, 132, 227, 0); }
            100% { box-shadow: 0 0 0 0 rgba(9, 132, 227, 0); }
        }

        @keyframes pulse-active {
            0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(0, 184, 148, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); }
        }

        @keyframes pulse-paused {
            0% { box-shadow: 0 0 0 0 rgba(232, 67, 147, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(232, 67, 147, 0); }
            100% { box-shadow: 0 0 0 0 rgba(232, 67, 147, 0); }
        }

        /* ===== MÉTRICAS ===== */
        .metrics-section {
            padding: 2rem 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .metric-card {
            background: var(--gradient-card);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--metric-gradient, var(--gradient-primary));
        }

        .metric-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .metric-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--white);
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }

        .metric-icon.participants {
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            --metric-gradient: linear-gradient(90deg, var(--secondary-color), #2980b9);
        }

        .metric-icon.time {
            background: linear-gradient(45deg, var(--danger-color), var(--primary-dark));
            --metric-gradient: linear-gradient(90deg, var(--danger-color), var(--primary-dark));
        }

        .metric-icon.questions {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            --metric-gradient: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .metric-icon.groups {
            background: linear-gradient(45deg, var(--warning-color), #e67e22);
            --metric-gradient: linear-gradient(90deg, var(--warning-color), #e67e22);
        }

        .metric-content {
            flex: 1;
            min-width: 0;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0 0 0.25rem 0;
            line-height: 1;
            color: var(--dark-color);
        }

        .metric-label {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .metric-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .metric-details span {
            font-size: 0.85rem;
            color: #95a5a6;
        }

        .metric-details strong {
            color: var(--dark-color);
        }

        .time-progress {
            margin-top: 0.75rem;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--warning-color), var(--danger-color));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ===== PANELES PRINCIPALES ===== */
        .control-section,
        .participants-section,
        .questions-control-section,
        .groups-section {
            padding: 1.5rem 0;
        }

        .control-panel,
        .info-panel,
        .participants-panel,
        .ranking-panel,
        .questions-control-panel,
        .groups-panel {
            background: var(--gradient-card);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .panel-header {
            background: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1.5rem 2rem;
        }

        .panel-header h4,
        .panel-header h5 {
            margin: 0;
            color: var(--dark-color);
            font-weight: 700;
        }

        .panel-body {
            padding: 2rem;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .competition-title {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .panel-header {
                padding: 1.5rem 0;
            }
            
            .title-text h1 {
                font-size: 1.5rem;
            }
            
            .pin-code {
                font-size: 2rem;
                letter-spacing: 6px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .metric-card {
                padding: 1.5rem;
                flex-direction: column;
                text-align: center;
            }
            
            .metric-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .metric-number {
                font-size: 2rem;
            }
            
            .panel-header,
            .panel-body {
                padding: 1.5rem;
            }
        }

        @media (max-width: 576px) {
            .metrics-section,
            .control-section,
            .participants-section,
            .questions-control-section,
            .groups-section {
                padding: 1rem 0;
            }
            
            .panel-header,
            .panel-body {
                padding: 1rem;
            }
            
            .header-controls {
                gap: 1rem;
            }
            
            .pin-container {
                padding: 1rem;
            }
            
            .status-badge {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

    </style>
</head>

<body class="panel-body">

<!-- MAIN CONTENT START -->
<main>
    <!-- Sidebar -->
    {% include 'docente/baseSideBar.html' %}
    
    <!-- Page Content -->
    <div class="page-content">
        
        <!-- Top bar -->
        {% include 'docente/navBar.html' %}
        
        <!-- Main Content -->
        <div class="page-content-wrapper">
            
            <!-- Header del Panel -->
            <section class="panel-header">
                <div class="container-fluid">
                    <div class="header-content">
                        <div class="competition-info">
                            <div class="competition-title">
                                <div class="title-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="title-text">
                                    <h1>{{ competencia.recurso.titulo }}</h1>
                                    <p>{{ competencia.instrucciones|truncatechars:100 }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="header-controls">
                            <!-- PIN Display -->
                            <div class="pin-container">
                                <div class="pin-label">PIN DE ACCESO</div>
                                <div class="pin-code" onclick="copyPin('{{ competencia.pin_acceso }}')">
                                    {{ competencia.pin_acceso }}
                                </div>
                                <div class="pin-actions">
                                    <button class="btn-pin" onclick="copyPin('{{ competencia.pin_acceso }}')">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                    <button class="btn-pin" onclick="sharePin('{{ competencia.pin_acceso }}')">
                                        <i class="fas fa-share"></i> Compartir
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Status Badge -->
                            <div class="status-badge status-{{ competencia.estado }}">
                                {% if competencia.estado == 'configuracion' %}
                                    <i class="fas fa-cog"></i>
                                    <span>Configuración</span>
                                {% elif competencia.estado == 'esperando' %}
                                    <i class="fas fa-clock"></i>
                                    <span>Esperando</span>
                                {% elif competencia.estado == 'activa' %}
                                    <i class="fas fa-play"></i>
                                    <span>En Vivo</span>
                                {% elif competencia.estado == 'pausada' %}
                                    <i class="fas fa-pause"></i>
                                    <span>Pausada</span>
                                {% elif competencia.estado == 'finalizada' %}
                                    <i class="fas fa-flag-checkered"></i>
                                    <span>Finalizada</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Métricas Principales -->
            <section class="metrics-section">
                <div class="container-fluid">
                    <div class="metrics-grid">
                        <!-- Participantes -->
                        <div class="metric-card">
                            <div class="metric-icon participants">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-number" id="total-participants">{{ total_participantes|default:0 }}</div>
                                <div class="metric-label">Participantes</div>
                                <div class="metric-details">
                                    <span>Activos: <strong id="active-participants">{{ participantes_activos|default:0 }}</strong></span>
                                    <span>Finalizaron: <strong id="finished-participants">{{ participantes_finalizados|default:0 }}</strong></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tiempo -->
                        <div class="metric-card">
                            <div class="metric-icon time">
                                <i class="fas fa-stopwatch"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-number" id="time-remaining">
                                    {% if competencia.estado == 'activa' and tiempo_restante %}
                                        {{ tiempo_restante|floatformat:0 }}
                                    {% else %}
                                        {{ competencia.tiempo_limite }}
                                    {% endif %}
                                </div>
                                <div class="metric-label">Minutos</div>
                                <div class="time-progress">
                                    <div class="progress-bar" id="time-progress-bar" 
                                         style="width: {% if tiempo_restante and competencia.tiempo_limite %}{% widthratio tiempo_restante competencia.tiempo_limite 100 %}{% else %}100{% endif %}%">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preguntas -->
                        <div class="metric-card">
                            <div class="metric-icon questions">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-number">{{ preguntas.count|default:0 }}</div>
                                <div class="metric-label">Preguntas</div>
                                <div class="metric-details">
                                    {% if competencia.estado == 'activa' and competencia.pregunta_actual %}
                                    <span>Actual: <strong>{{ competencia.pregunta_actual.orden }}</strong></span>
                                    <span>Progreso: <strong>{% widthratio competencia.pregunta_actual.orden preguntas.count 100 %}%</strong></span>
                                    {% else %}
                                    <span>Total: <strong>{{ preguntas.count }}</strong></span>
                                    <span>Progreso: <strong>0%</strong></span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Grupos/Completados -->
                        <div class="metric-card">
                            <div class="metric-icon groups">
                                {% if competencia.modalidad == 'grupal' %}
                                    <i class="fas fa-layer-group"></i>
                                {% else %}
                                    <i class="fas fa-trophy"></i>
                                {% endif %}
                            </div>
                            <div class="metric-content">
                                {% if competencia.modalidad == 'grupal' %}
                                    <div class="metric-number">{{ grupos.count|default:0 }}</div>
                                    <div class="metric-label">Grupos</div>
                                    <div class="metric-details">
                                        <span>Max: <strong>{{ competencia.max_miembros_grupo }}</strong></span>
                                        <span>Sin grupo: <strong id="no-group">{{ participantes_sin_grupo|default:0 }}</strong></span>
                                    </div>
                                {% else %}
                                    <div class="metric-number">{{ participantes_finalizados|default:0 }}</div>
                                    <div class="metric-label">Completados</div>
                                    <div class="metric-details">
                                        <span>Activos: <strong id="active-count">{{ participantes_activos|default:0 }}</strong></span>
                                        <span>Total: <strong>{{ total_participantes|default:0 }}</strong></span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Control Principal -->
            <section class="control-section">
                <div class="container-fluid">
                    <div class="row g-4">
                        <!-- Panel de Control -->
                        <div class="col-lg-8">
                            <div class="control-panel">
                                <div class="panel-header">
                                    <h4><i class="fas fa-gamepad me-3"></i>Control de Competencia</h4>
                                </div>
                                <div class="panel-body">
                                    <!-- Control según Estado -->
                                    <div class="state-control" id="state-control-{{ competencia.estado }}">
                                        {% include 'docente/competencias/partials/estados_control.html' %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panel de Información -->
                        <div class="col-lg-4">
                            <div class="info-panel">
                                <div class="panel-header">
                                    <h5><i class="fas fa-info-circle me-3"></i>Información</h5>
                                </div>
                                <div class="panel-body">
                                    {% include 'docente/competencias/partials/info_competencia.html' %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Participantes y Ranking -->
            <section class="participants-section">
                <div class="container-fluid">
                    <div class="row g-4">
                        <!-- Lista de Participantes -->
                        <div class="col-lg-6">
                            <div class="participants-panel">
                                {% include 'docente/competencias/partials/lista_participantes.html' %}
                            </div>
                        </div>
                        
                        <!-- Ranking -->
                        <div class="col-lg-6">
                            <div class="ranking-panel">
                                {% include 'docente/competencias/partials/lista_ranking.html' %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Control de Preguntas (Solo si está activa) -->
            {% if competencia.estado == 'activa' %}
            <section class="questions-control-section">
                <div class="container-fluid">
                    <div class="questions-control-panel">
                        {% include 'docente/competencias/partials/control_preguntas.html' %}
                    </div>
                </div>
            </section>
            {% endif %}
            
            <!-- Gestión de Grupos (Solo si es grupal) -->
            {% if competencia.modalidad == 'grupal' and competencia.estado in 'esperando,activa' %}
            <section class="groups-section">
                <div class="container-fluid">
                    <div class="groups-panel">
                        {% include 'docente/competencias/partials/gestion_grupos.html' %}
                    </div>
                </div>
            </section>
            {% endif %}
            
        </div>
    </div>
</main>

<!-- Scripts -->
<script src="{% static 'assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'assets/js/functions.js' %}"></script>
<script src="{% static 'assets/js/panel-control.js' %}"></script>
<script>
    /**
     * =====================================================
     * PANEL DE CONTROL - JAVASCRIPT PRINCIPAL
     * =====================================================
     */

    class CompetitionPanel {
        constructor(competitionId, currentState) {
            this.competitionId = competitionId;
            this.currentState = currentState;
            this.isUpdating = false;
            this.intervals = {};
            
            this.init();
        }
        
        init() {
            console.log('🏆 Inicializando Panel de Control');
            console.log(`📊 Competencia: ${this.competitionId}`);
            console.log(`🔄 Estado: ${this.currentState}`);
            
            this.setupEventListeners();
            this.startLiveUpdates();
            
            // Teclas de acceso rápido
            this.setupKeyboardShortcuts();
        }
        
        setupEventListeners() {
            // Event listeners para botones principales
            document.addEventListener('click', (e) => {
                if (e.target.closest('.pin-code') || e.target.closest('.btn-pin[onclick*="copyPin"]')) {
                    const pin = document.querySelector('.pin-code').textContent.trim();
                    this.copyPin(pin);
                }
            });
            
            // Prevenir pérdida de datos al cerrar
            window.addEventListener('beforeunload', () => {
                this.stopLiveUpdates();
            });
        }
        
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (this.currentState === 'activa' && !e.target.matches('input, textarea, select')) {
                    switch(e.key) {
                        case 'ArrowRight':
                            e.preventDefault();
                            this.nextQuestion();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.previousQuestion();
                            break;
                        case ' ': // Espacebar
                            e.preventDefault();
                            this.pauseCompetition();
                            break;
                        case 'r':
                            e.preventDefault();
                            this.updateAll();
                            break;
                    }
                }
            });
        }
        
        // ===== CONTROL PRINCIPAL =====
        
        async openWaitingRoom() {
            const confirmed = await this.showConfirmation(
                'Abrir Sala de Espera',
                '¿Estás listo para abrir la sala de espera? Los estudiantes podrán unirse con el PIN.'
            );
            
            if (!confirmed) return;
            
            const loading = this.showLoading('Abriendo sala de espera...');
            
            try {
                const response = await fetch(`/docente/competencia/abrir-sala-espera/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess('Sala de espera abierta. Los estudiantes pueden unirse ahora.');
                    this.currentState = 'esperando';
                    this.updateStateUI('esperando');
                    this.startLiveUpdates();
                } else {
                    this.showError(data.error || 'Error al abrir sala de espera');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        async startCompetition() {
            const confirmed = await this.showConfirmation(
                '¡Iniciar Competencia!',
                '¿Estás listo para iniciar la competencia? Una vez iniciada, los estudiantes comenzarán a responder.'
            );
            
            if (!confirmed) return;
            
            const loading = this.showLoading('Iniciando competencia...');
            
            try {
                const response = await fetch(`/docente/competencia/iniciar/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess('¡Competencia iniciada exitosamente!');
                    this.currentState = 'activa';
                    this.updateStateUI('activa');
                    this.startLiveUpdates();
                } else {
                    this.showError(data.error || 'Error al iniciar competencia');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        async pauseCompetition() {
            const confirmed = await this.showConfirmation(
                'Pausar Competencia',
                '¿Pausar la competencia temporalmente? Los estudiantes esperarán hasta que reanudes.'
            );
            
            if (!confirmed) return;
            
            const loading = this.showLoading('Pausando competencia...');
            
            try {
                const response = await fetch(`/docente/competencia/pausar/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess('Competencia pausada');
                    this.currentState = 'pausada';
                    this.updateStateUI('pausada');
                } else {
                    this.showError(data.error || 'Error al pausar competencia');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        async resumeCompetition() {
            const loading = this.showLoading('Reanudando competencia...');
            
            try {
                const response = await fetch(`/docente/competencia/reanudar/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess('Competencia reanudada');
                    this.currentState = 'activa';
                    this.updateStateUI('activa');
                } else {
                    this.showError(data.error || 'Error al reanudar competencia');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        async finishCompetition() {
            const confirmed = await this.showConfirmation(
                'Finalizar Competencia',
                '¿Estás seguro de finalizar la competencia? Esto calculará los resultados finales y no se puede deshacer.'
            );
            
            if (!confirmed) return;
            
            const loading = this.showLoading('Finalizando competencia...');
            
            try {
                const response = await fetch(`/docente/competencia/finalizar/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess('Competencia finalizada exitosamente');
                    this.currentState = 'finalizada';
                    this.stopLiveUpdates();
                    this.updateStateUI('finalizada');
                    
                    setTimeout(() => {
                        this.showInfo('Redirigiendo a los resultados...');
                        window.location.href = `/docente/competencia/resultados/${this.competitionId}/`;
                    }, 3000);
                } else {
                    this.showError(data.error || 'Error al finalizar competencia');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        // ===== CONTROL DE PREGUNTAS =====
        
        async nextQuestion() {
            const loading = this.showLoading('Avanzando a siguiente pregunta...');
            
            try {
                const response = await fetch(`/docente/competencia/siguiente-pregunta/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess(data.mensaje || 'Pregunta avanzada');
                    if (data.finalizada) {
                        setTimeout(() => {
                            window.location.href = `/docente/competencia/resultados/${this.competitionId}/`;
                        }, 2000);
                    }
                } else {
                    this.showError(data.error || 'Error al avanzar pregunta');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        async previousQuestion() {
            const loading = this.showLoading('Regresando a pregunta anterior...');
            
            try {
                const response = await fetch(`/docente/competencia/pregunta-anterior/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess('Pregunta anterior mostrada');
                } else {
                    this.showError(data.error || 'Error al retroceder pregunta');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        async goToQuestion(questionId) {
            const loading = this.showLoading('Cambiando pregunta...');
            
            try {
                const response = await fetch(`/docente/competencia/ir-pregunta/${this.competitionId}/${questionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                
                const data = await response.json();
                loading.hide();
                
                if (data.success) {
                    this.showSuccess(`Cambiado a pregunta ${data.pregunta_orden}`);
                } else {
                    this.showError(data.error || 'Error al cambiar pregunta');
                }
            } catch (error) {
                loading.hide();
                this.showError('Error de conexión');
                console.error('Error:', error);
            }
        }
        
        // ===== ACTUALIZACIONES EN VIVO =====
        
        startLiveUpdates() {
            if (this.isUpdating) return;
            
            this.isUpdating = true;
            console.log('🔴 Iniciando actualizaciones en vivo');
            
            // Configurar intervalos según el estado
            if (this.currentState === 'esperando' || this.currentState === 'activa') {
                this.intervals.participants = setInterval(() => this.updateParticipants(), 5000);
                this.intervals.ranking = setInterval(() => this.updateRanking(), 8000);
                this.intervals.metrics = setInterval(() => this.updateMetrics(), 3000);
                
                if (this.currentState === 'activa') {
                    this.intervals.time = setInterval(() => this.updateTime(), 1000);
                }
                
                this.intervals.heartbeat = setInterval(() => this.sendHeartbeat(), 15000);
            }
        }
        
        stopLiveUpdates() {
            this.isUpdating = false;
            console.log('⏹️ Deteniendo actualizaciones en vivo');
            
            Object.keys(this.intervals).forEach(key => {
                if (this.intervals[key]) {
                    clearInterval(this.intervals[key]);
                    delete this.intervals[key];
                }
            });
        }
        
        async updateParticipants() {
            try {
                const response = await fetch(`/docente/competencia/participantes/${this.competitionId}/`);
                const data = await response.json();
                
                if (data.success) {
                    this.updateElement('total-participants', data.total);
                    this.updateElement('active-participants', data.activos);
                    this.updateElement('finished-participants', data.finalizados);
                    
                    if (data.participantes) {
                        this.updateParticipantsList(data.participantes);
                    }
                }
            } catch (error) {
                console.warn('Error actualizando participantes:', error);
            }
        }
        
        async updateRanking() {
            try {
                const response = await fetch(`/docente/competencia/ranking/${this.competitionId}/`);
                const data = await response.json();
                
                if (data.success && data.ranking) {
                    this.updateRankingList(data.ranking);
                }
            } catch (error) {
                console.warn('Error actualizando ranking:', error);
            }
        }
        
        async updateMetrics() {
            try {
                const response = await fetch(`/docente/competencia/metricas/${this.competitionId}/`);
                const data = await response.json();
                
                if (data.success) {
                    Object.keys(data.metricas).forEach(metric => {
                        this.updateElement(metric, data.metricas[metric]);
                    });
                }
            } catch (error) {
                console.warn('Error actualizando métricas:', error);
            }
        }
        
        async updateTime() {
            if (this.currentState !== 'activa') return;
            
            try {
                const response = await fetch(`/docente/competencia/tiempo-restante/${this.competitionId}/`);
                const data = await response.json();
                
                if (data.success) {
                    const minutes = Math.max(0, Math.floor(data.tiempo_restante / 60));
                    this.updateElement('time-remaining', minutes);
                    
                    // Actualizar barra de progreso
                    const progressBar = document.getElementById('time-progress-bar');
                    if (progressBar && data.tiempo_total) {
                        const percentage = Math.max(0, (data.tiempo_restante / (data.tiempo_total * 60)) * 100);
                        progressBar.style.width = `${percentage}%`;
                    }
                    
                    // Si el tiempo se agotó
                    if (data.tiempo_restante <= 0) {
                        this.showInfo('Tiempo agotado. Finalizando competencia automáticamente...');
                        this.stopLiveUpdates();
                        setTimeout(() => this.finishCompetition(), 3000);
                    }
                }
            } catch (error) {
                console.warn('Error actualizando tiempo:', error);
            }
        }
        
        async sendHeartbeat() {
            try {
                await fetch(`/docente/competencia/heartbeat/${this.competitionId}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                console.log('💓 Heartbeat enviado');
            } catch (error) {
                console.warn('Error en heartbeat:', error);
            }
        }
        
        // ===== UTILIDADES =====
        
        async updateAll() {
            const loading = this.showLoading('Actualizando información...');
            
            try {
                await Promise.all([
                    this.updateParticipants(),
                    this.updateRanking(),
                    this.updateMetrics()
                ]);
                
                loading.hide();
                this.showSuccess('Información actualizada');
            } catch (error) {
                loading.hide();
                this.showError('Error al actualizar información');
                console.error('Error:', error);
            }
        }
        
        copyPin(pin) {
            navigator.clipboard.writeText(pin).then(() => {
                this.showSuccess(`PIN ${pin} copiado al portapapeles`);
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = pin;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                this.showSuccess(`PIN ${pin} copiado al portapapeles`);
            });
        }
        
        sharePin(pin) {
            const url = `${window.location.origin}/estudiante/competencia/unirse/${pin}/`;
            const text = `¡Únete a mi competencia!\n\nPIN: ${pin}\nEnlace: ${url}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Competencia - PIN de Acceso',
                    text: text,
                    url: url
                });
            } else {
                this.copyPin(text);
                this.showInfo('Información de la competencia copiada al portapapeles');
            }
        }
        
        // ===== UI HELPERS =====
        
        updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                const currentValue = parseInt(element.textContent) || 0;
                const newValue = parseInt(value) || 0;
                
                if (currentValue !== newValue) {
                    element.style.transform = 'scale(1.1)';
                    element.style.color = 'var(--primary-color)';
                    
                    setTimeout(() => {
                        element.textContent = newValue;
                        element.style.transform = 'scale(1)';
                        element.style.color = '';
                    }, 200);
                }
            }
        }
        
        updateStateUI(newState) {
            // Actualizar badge de estado
            const stateBadge = document.querySelector('.status-badge');
            if (stateBadge) {
                stateBadge.className = stateBadge.className.replace(/status-\w+/g, '');
                stateBadge.classList.add(`status-${newState}`);
                
                // Actualizar contenido del badge
                const stateConfig = {
                    'configuracion': { icon: 'fas fa-cog', text: 'Configuración' },
                    'esperando': { icon: 'fas fa-clock', text: 'Esperando' },
                    'activa': { icon: 'fas fa-play', text: 'En Vivo' },
                    'pausada': { icon: 'fas fa-pause', text: 'Pausada' },
                    'finalizada': { icon: 'fas fa-flag-checkered', text: 'Finalizada' }
                };
                
                const config = stateConfig[newState];
                if (config) {
                    stateBadge.innerHTML = `<i class="${config.icon}"></i><span>${config.text}</span>`;
                }
            }
            
            // Recargar página después de un tiempo para actualizar controles
            setTimeout(() => location.reload(), 2000);
        }
        
        updateParticipantsList(participants) {
            // Implementar actualización dinámica de lista
            console.log('Actualizando lista de participantes:', participants);
        }
        
        updateRankingList(ranking) {
            // Implementar actualización dinámica de ranking
            console.log('Actualizando ranking:', ranking);
        }
        
        // ===== NOTIFICACIONES =====
        
        showSuccess(message) {
            this.showToast(message, 'success', 'fas fa-check-circle');
        }
        
        showError(message) {
            this.showToast(message, 'danger', 'fas fa-exclamation-triangle');
        }
        
        showInfo(message) {
            this.showToast(message, 'info', 'fas fa-info-circle');
        }
        
        showLoading(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-primary border-0 position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="toast-body">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                        <span>${message}</span>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { autohide: false });
            bsToast.show();
            
            return {
                hide: () => {
                    bsToast.hide();
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }
            };
        }
        
        showToast(message, type, icon) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="toast-body">
                    <div class="d-flex align-items-center">
                        <i class="${icon} me-3"></i>
                        <span>${message}</span>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            `;
            
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: type === 'danger' ? 6000 : 4000 });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            });
        }
        
        showConfirmation(title, message) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    ${title}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary confirm-btn">Confirmar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                
                modal.querySelector('.confirm-btn').addEventListener('click', () => {
                    bsModal.hide();
                    resolve(true);
                });
                
                modal.addEventListener('hidden.bs.modal', () => {
                    if (!modal.confirmed) resolve(false);
                    modal.remove();
                });
                
                bsModal.show();
            });
        }
        
        getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return decodeURIComponent(value);
                }
            }
            return '';
        }
    }

    // ===== FUNCIONES GLOBALES PARA COMPATIBILIDAD =====

    let panelInstance = null;

    // Funciones principales
    function abrirSalaEspera() { panelInstance?.openWaitingRoom(); }
    function iniciarCompetencia() { panelInstance?.startCompetition(); }
    function pausarCompetencia() { panelInstance?.pauseCompetition(); }
    function reanudarCompetencia() { panelInstance?.resumeCompetition(); }
    function finalizarCompetencia() { panelInstance?.finishCompetition(); }
    function siguientePregunta() { panelInstance?.nextQuestion(); }
    function preguntaAnterior() { panelInstance?.previousQuestion(); }
    function irAPregunta(id) { panelInstance?.goToQuestion(id); }
    function actualizarTodo() { panelInstance?.updateAll(); }
    function copiarPin(pin) { panelInstance?.copyPin(pin); }
    function compartirPin(pin) { panelInstance?.sharePin(pin); }

    // ===== INICIALIZACIÓN =====

    document.addEventListener('DOMContentLoaded', function() {
        // Obtener datos de la competencia desde el template
        const competitionId = window.competitionData?.id || null;
        const currentState = window.competitionData?.state || 'configuracion';
        
        if (competitionId) {
            panelInstance = new CompetitionPanel(competitionId, currentState);
            console.log('✅ Panel de Control inicializado');
        } else {
            console.error('❌ No se pudo inicializar el panel: faltan datos de competencia');
        }
    });

    // ===== DATOS GLOBALES =====
    // Estos datos deben ser inyectados desde el template Django
    window.competitionData = {
        id: {{ competencia.id|default:"null" }},
        state: '{{ competencia.estado|default:"configuracion" }}',
        pin: '{{ competencia.pin_acceso|default:"" }}',
        title: '{{ competencia.recurso.titulo|default:""|escapejs }}',
        mode: '{{ competencia.modalidad|default:"individual" }}'
    };

</script>

</body>
</html>
