<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <title>Eduport - Realizar Cuestionario: {{ cuestionario.recurso.titulo }}</title>

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Webestica.com">
    <meta name="description" content="Eduport- LMS, Education and Course Theme">
    
    <!-- CSRF Token para AJAX -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'assets/images/favicon.ico' %}">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap">

    <!-- Plugins CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'assets/vendor/font-awesome/css/all.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/vendor/stepper/css/bs-stepper.min.css' %}">

    <!-- Theme CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/style.css' %}">
    
    <!-- Estilos personalizados para el cuestionario -->
    <style>
        /* ===== ESTILOS DEL CUESTIONARIO ===== */
        .quiz-container {
            min-height: 600px;
        }
        
        .quiz-question {
            min-height: 400px;
            transition: all 0.3s ease;
        }
        
        .quiz-option {
            transition: all 0.2s ease;
            border: 2px solid transparent;
            margin-bottom: 10px;
        }
        
        .quiz-option:hover {
            border-color: #0d6efd;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.15);
            transform: translateY(-2px);
        }
        
        .quiz-option.selected {
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            color: white;
            border-color: #0d6efd;
        }
        
        .quiz-option.selected:hover {
            color: white;
        }
        
        /* Timer styling */
        .timer-container {
            position: sticky;
            top: 20px;
            z-index: 1000;
        }
        
        .timer-warning {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .timer-critical {
            background: linear-gradient(135deg, #dc3545, #fd7e14) !important;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Progress bar styling */
        .quiz-progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .quiz-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        /* Stepper customizations */
        .bs-stepper-circle {
            background: #6c757d !important;
            border-color: #6c757d !important;
        }
        
        .step.active .bs-stepper-circle {
            background: #0d6efd !important;
            border-color: #0d6efd !important;
        }
        
        .step.completed .bs-stepper-circle {
            background: #28a745 !important;
            border-color: #28a745 !important;
        }
        
        /* Question types styling */
        .textarea-respuesta {
            min-height: 120px;
            resize: vertical;
        }
        
        .completar-input {
            border: none;
            border-bottom: 2px solid #0d6efd;
            background: transparent;
            display: inline-block;
            min-width: 80px;
            text-align: center;
            margin: 0 5px;
        }
        
        .completar-input:focus {
            outline: none;
            border-bottom-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        /* Molecular editor styling */
        .molecular-editor {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        .molecular-editor.active {
            border-color: #0d6efd;
            background: rgba(13, 110, 254, 0.05);
        }
        
        /* Save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transform: translateX(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1050;
        }
        
        .save-indicator.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        /* Navigation buttons */
        .nav-quiz-btn {
            border-radius: 25px;
            padding: 0.7rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Question counter */
        .question-counter {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            padding: 5px 15px;
            font-weight: 600;
        }
        
        /* Auto-save status */
        .autosave-status {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .autosave-status.saving {
            color: #ffc107;
        }
        
        .autosave-status.saved {
            color: #28a745;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center text-white">
        <div class="loading-spinner mx-auto mb-3"></div>
        <p>Guardando respuesta...</p>
    </div>
</div>

<!-- Auto-save Indicator -->
<div class="save-indicator" id="saveIndicator">
    <i class="fas fa-check me-2"></i>
    <span>Respuesta guardada</span>
</div>

<!-- Header START -->
<header class="navbar-light navbar-sticky">
    <!-- Logo Nav START -->
    <nav class="navbar navbar-expand-xl">
        <div class="container">
            <!-- Logo START -->
            <a class="navbar-brand" href="{% url 'student_dashboard' %}">
                <img class="light-mode-item navbar-brand-item" src="{% static 'assets/images/logo.svg' %}" alt="logo">
                <img class="dark-mode-item navbar-brand-item" src="{% static 'assets/images/logo-light.svg' %}" alt="logo">
            </a>
            <!-- Logo END -->

            <!-- Quiz Info in Header -->
            <div class="navbar-collapse w-100">
                <div class="navbar-nav mx-auto">
                    <div class="nav-item text-center">
                        <h5 class="mb-0">{{ cuestionario.recurso.titulo }}</h5>
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>{{ usuario }}
                            <span class="mx-2">•</span>
                            <i class="fas fa-calendar me-1"></i>{{ intento.fecha_inicio|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Timer and Progress START -->
            <div class="ms-auto d-flex align-items-center">
                <!-- Progress Info -->
                <div class="me-3 text-end d-none d-md-block">
                    <div class="question-counter">
                        <span id="currentQuestion">1</span> / {{ preguntas.count }}
                    </div>
                    <div class="autosave-status mt-1" id="autosaveStatus">
                        <i class="fas fa-sync-alt me-1"></i>
                        <span>Auto-guardado activo</span>
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="timer-container">
                    <div class="card border-0 shadow-sm" id="timerCard">
                        <div class="card-body p-3 text-center">
                            <div class="h4 mb-1 text-primary" id="timerDisplay">
                                <i class="fas fa-clock me-2"></i>
                                <span id="timeLeft">{{ tiempo_restante }}</span>
                            </div>
                            <small class="text-muted">Tiempo restante</small>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Timer and Progress END -->
        </div>
    </nav>
    <!-- Logo Nav END -->
</header>
<!-- Header END -->
 <!-- **************** MAIN CONTENT START **************** -->
<main>
    
<!-- =======================
Page Banner START -->
<section class="pt-0">
    <div class="container-fluid px-0">
        <div class="card bg-blue h-100px h-md-200px rounded-0" style="background:url('{% static 'assets/images/pattern/04.png' %}') no-repeat center center; background-size:cover;">
        </div>
    </div>
    <div class="container mt-n4">
        <div class="row">
            <div class="col-12">
                <div class="card bg-transparent card-body pb-0 px-0 mt-2 mt-sm-0">
                    <div class="row d-sm-flex justify-sm-content-between mt-2 mt-md-0">
                        <!-- Avatar -->
                        <div class="col-auto">
                            <div class="avatar avatar-xxl position-relative mt-n3">
                                <img class="avatar-img rounded-circle border border-white border-3 shadow" src="{% if imgPerfil %}{{ imgPerfil.url }}{% else %}{% static 'assets/images/avatar/09.jpg' %}{% endif %}" alt="{{ usuario }}">
                                <span class="badge text-bg-success rounded-pill position-absolute top-50 start-100 translate-middle mt-4 mt-md-5 ms-n3 px-md-3">
                                    <i class="fas fa-play me-1"></i>En Curso
                                </span>
                            </div>
                        </div>
                        <!-- Profile info -->
                        <div class="col d-sm-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="my-1 fs-4">{{ usuario }}</h1>
                                <ul class="list-inline mb-0">
                                    <li class="list-inline-item me-3 mb-1 mb-sm-0">
                                        <span class="h6">{{ intento.numero_intento }}</span>
                                        <span class="text-body fw-light">Intento actual</span>
                                    </li>
                                    <li class="list-inline-item me-3 mb-1 mb-sm-0">
                                        <span class="h6">{{ cuestionario.preguntas.count }}</span>
                                        <span class="text-body fw-light">Preguntas totales</span>
                                    </li>
                                    <li class="list-inline-item me-3 mb-1 mb-sm-0">
                                        <span class="h6">{{ cuestionario.puntaje_total|floatformat:0 }}</span>
                                        <span class="text-body fw-light">Puntos posibles</span>
                                    </li>
                                </ul>
                            </div>
                            <!-- Button -->
                            <div class="mt-2 mt-sm-0">
                                <button class="btn btn-outline-danger mb-0" onclick="confirmarSalir()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Salir del Cuestionario
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar Global -->
                <div class="card mt-3">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Progreso del Cuestionario</h6>
                            <span class="text-muted small">
                                <span id="answeredCount">0</span> de {{ preguntas.count }} respondidas
                            </span>
                        </div>
                        <div class="quiz-progress">
                            <div class="quiz-progress-bar" id="globalProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Advanced filter responsive toggler START -->
                <!-- Divider -->
                <hr class="d-xl-none">
                <div class="col-12 col-xl-3 d-flex justify-content-between align-items-center">
                    <a class="h6 mb-0 fw-bold d-xl-none" href="#">Navegación</a>
                    <button class="btn btn-primary d-xl-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <!-- Advanced filter responsive toggler END -->
            </div>
        </div>
    </div>
</section>
<!-- =======================
Page Banner END -->

<!-- =======================
Page content START -->
<section class="pt-0">
    <div class="container">
        <div class="row">

            <!-- Left sidebar START -->
            <div class="col-xl-3">
                <!-- Responsive offcanvas body START -->
                <div class="offcanvas-xl offcanvas-end" tabindex="-1" id="offcanvasSidebar">
                    <!-- Offcanvas header -->
                    <div class="offcanvas-header bg-light">
                        <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Navegación del Cuestionario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasSidebar" aria-label="Close"></button>
                    </div>
                    <!-- Offcanvas body -->
                    <div class="offcanvas-body p-3 p-xl-0">
                        <div class="bg-dark border rounded-3 p-3 w-100">
                            <!-- Question Navigation -->
                            <div class="mb-4">
                                <h6 class="text-white mb-3">
                                    <i class="fas fa-map me-2"></i>Mapa de Preguntas
                                </h6>
                                <div class="row g-2" id="questionMap">
                                    {% for pregunta in preguntas %}
                                    <div class="col-3">
                                        <button class="btn btn-sm btn-outline-light w-100 question-nav-btn" 
                                                data-question="{{ forloop.counter }}" 
                                                data-question-id="{{ pregunta.id }}"
                                                onclick="goToQuestion({{ forloop.counter }})">
                                            {{ forloop.counter }}
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Legend -->
                                <div class="mt-3">
                                    <small class="text-light">
                                        <div class="d-flex align-items-center mb-1">
                                            <div class="bg-secondary rounded me-2" style="width: 15px; height: 15px;"></div>
                                            <span>Sin responder</span>
                                        </div>
                                        <div class="d-flex align-items-center mb-1">
                                            <div class="bg-primary rounded me-2" style="width: 15px; height: 15px;"></div>
                                            <span>Pregunta actual</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success rounded me-2" style="width: 15px; height: 15px;"></div>
                                            <span>Respondida</span>
                                        </div>
                                    </small>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="list-group list-group-dark list-group-borderless">
                                <a class="list-group-item" href="#" onclick="marcarParaRevision()">
                                    <i class="bi bi-flag fa-fw me-2"></i>Marcar para revisar
                                </a>
                                <a class="list-group-item" href="#" onclick="mostrarResumen()">
                                    <i class="bi bi-list-check fa-fw me-2"></i>Resumen de respuestas
                                </a>
                                <a class="list-group-item" href="#" onclick="guardarBorrador()">
                                    <i class="bi bi-save fa-fw me-2"></i>Guardar borrador
                                </a>
                                <a class="list-group-item" href="#" onclick="verInstrucciones()">
                                    <i class="bi bi-info-circle fa-fw me-2"></i>Ver instrucciones
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="list-group-item text-warning" href="#" onclick="finalizarCuestionario()">
                                    <i class="bi bi-check-circle fa-fw me-2"></i>Finalizar Cuestionario
                                </a>
                                <a class="list-group-item text-danger" href="#" onclick="confirmarSalir()">
                                    <i class="fas fa-sign-out-alt fa-fw me-2"></i>Salir sin Guardar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Responsive offcanvas body END -->
            </div>
            <!-- Left sidebar END -->
             <!-- Main content START -->
            <div class="col-xl-9">

                <!-- Course item START -->
                <div class="card border quiz-container">
    
                    <div class="card-header border-bottom">
                        <!-- Course list START -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="row g-0">
                                        <div class="col-md-2">
                                            <img src="{% if cuestionario.recurso.imagen %}{{ cuestionario.recurso.imagen.url }}{% else %}{% static 'img/Plataforma/General/default_cuestionario.jpg' %}{% endif %}" 
                                                 class="rounded-2" alt="Imagen del cuestionario">
                                        </div>
                                        <div class="col-md-10">
                                            <div class="card-body">
                                                <!-- Title -->
                                                <h3 class="card-title">
                                                    <a href="#">{{ cuestionario.recurso.titulo }}</a>
                                                </h3>
                                                <p class="card-text">{{ cuestionario.instrucciones }}</p>
                                                
                                                <!-- Quiz Info -->
                                                <div class="row text-center mt-3">
                                                    <div class="col-md-3">
                                                        <div class="bg-light p-2 rounded">
                                                            <i class="fas fa-question-circle text-primary mb-1 d-block"></i>
                                                            <strong>{{ preguntas.count }}</strong>
                                                            <small class="d-block text-muted">Preguntas</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="bg-light p-2 rounded">
                                                            <i class="fas fa-clock text-warning mb-1 d-block"></i>
                                                            <strong>{{ cuestionario.tiempo_limite }}</strong>
                                                            <small class="d-block text-muted">Minutos</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="bg-light p-2 rounded">
                                                            <i class="fas fa-star text-success mb-1 d-block"></i>
                                                            <strong>{{ cuestionario.puntaje_total|floatformat:0 }}</strong>
                                                            <small class="d-block text-muted">Puntos</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="bg-light p-2 rounded">
                                                            <i class="fas fa-redo text-info mb-1 d-block"></i>
                                                            <strong>{{ intento.numero_intento }}</strong>
                                                            <small class="d-block text-muted">Intento</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Course list END -->
                    </div>

                    <div class="card-body">
                        <!-- Step content START -->
                        <div class="card bg-transparent border rounded-3 mb-1">
                            <div id="stepper" class="bs-stepper stepper-outline">
                                <!-- Card header -->
                                <div class="card-header bg-light border-bottom px-lg-5">
                                    <!-- Step Buttons START -->
                                    <div class="bs-stepper-header" role="tablist">
                                        {% for pregunta in preguntas %}
                                        <div class="step" data-target="#step-{{ forloop.counter }}">
                                            <div class="d-grid text-center align-items-center">
                                                <button type="button" class="btn btn-link step-trigger mb-0" 
                                                        role="tab" id="steppertrigger{{ forloop.counter }}" 
                                                        aria-controls="step-{{ forloop.counter }}"
                                                        onclick="goToQuestion({{ forloop.counter }})">
                                                    <span class="bs-stepper-circle">{{ forloop.counter }}</span>
                                                </button>
                                            </div>
                                        </div>
                                        {% if not forloop.last %}
                                        <div class="line"></div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    <!-- Step Buttons END -->
                                </div>
        
                                <!-- Card body START -->
                                <div class="card-body">

                                    <!-- Timer en el body (móvil) -->
                                    <div class="d-md-none mb-3">
                                        <div class="alert alert-info text-center" id="mobileTimer">
                                            <h6 class="mb-1">
                                                <i class="fas fa-clock me-2"></i>
                                                Tiempo restante: <span id="mobileTimeLeft">{{ tiempo_restante }}</span>
                                            </h6>
                                            <div class="question-counter mt-2">
                                                Pregunta <span id="mobileCurrentQuestion">1</span> de {{ preguntas.count }}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step content START -->
                                    <div class="bs-stepper-content">
                                        <form id="quizForm">
                                            {% csrf_token %}
                                            <input type="hidden" id="intentoId" value="{{ intento.id }}">
                                            
                                            {% for pregunta in preguntas %}
                                            <!-- Pregunta {{ forloop.counter }} content START -->
                                            <div id="step-{{ forloop.counter }}" role="tabpanel" 
                                                 class="content fade quiz-question{% if forloop.first %} active show{% endif %}" 
                                                 aria-labelledby="steppertrigger{{ forloop.counter }}"
                                                 data-question-id="{{ pregunta.id }}"
                                                 data-question-type="{{ pregunta.tipo.nombre }}">
                                                
                                                <!-- Question Header -->
                                                <div class="row mb-4">
                                                    <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <div class="question-counter">
                                                                Pregunta {{ forloop.counter }}
                                                            </div>
                                                            <div class="text-end">
                                                                <span class="badge bg-primary">{{ pregunta.puntaje }} punto{{ pregunta.puntaje|pluralize }}</span>
                                                                {% if pregunta.calificacion_manual %}
                                                                <span class="badge bg-warning ms-1" title="Requiere calificación manual">
                                                                    <i class="fas fa-user-check"></i> Manual
                                                                </span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Question Title -->
                                                        <h4 class="mb-3">{{ pregunta.enunciado }}</h4>
                                                        
                                                        <!-- Multimedia Content -->
                                                        {% if pregunta.archivo_multimedia %}
                                                        <div class="mb-3">
                                                            {% with extension=pregunta.archivo_multimedia.name|slice:"-4:" %}
                                                            {% if extension == ".jpg" or extension == ".png" or extension == ".gif" or extension == "jpeg" %}
                                                                <img src="{{ pregunta.archivo_multimedia.url }}" class="img-fluid rounded" alt="Imagen de la pregunta">
                                                            {% elif extension == ".mp4" or extension == ".mov" or extension == ".avi" %}
                                                                <video controls class="img-fluid rounded">
                                                                    <source src="{{ pregunta.archivo_multimedia.url }}" type="video/mp4">
                                                                    Tu navegador no soporta el elemento video.
                                                                </video>
                                                            {% elif extension == ".mp3" or extension == ".wav" %}
                                                                <audio controls class="w-100">
                                                                    <source src="{{ pregunta.archivo_multimedia.url }}" type="audio/mpeg">
                                                                    Tu navegador no soporta el elemento audio.
                                                                </audio>
                                                            {% else %}
                                                                <a href="{{ pregunta.archivo_multimedia.url }}" target="_blank" class="btn btn-outline-primary">
                                                                    <i class="fas fa-download me-2"></i>Descargar archivo adjunto
                                                                </a>
                                                            {% endif %}
                                                            {% endwith %}
                                                        </div>
                                                        {% endif %}
                                                        
                                                        <!-- YouTube Video -->
                                                        {% if pregunta.url_youtube %}
                                                        <div class="mb-3">
                                                            <div class="ratio ratio-16x9">
                                                                <iframe src="https://www.youtube.com/embed/{{ pregunta.url_youtube }}" 
                                                                        title="Video de YouTube" allowfullscreen></iframe>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <hr> <!-- Divider -->
                                                
                                                <!-- OPCIONES SEGÚN EL TIPO DE PREGUNTA -->
                                                
                                                {% if pregunta.tipo.nombre == 'opcion_unica' or pregunta.tipo.nombre == 'falso_verdadero' %}
                                                <!-- PREGUNTA DE OPCIÓN ÚNICA / VERDADERO-FALSO -->
                                                <div class="vstack gap-2">
                                                    {% for opcion in pregunta.opciones.all %}
                                                    <div>
                                                        <input type="radio" class="btn-check" 
                                                               name="pregunta_{{ pregunta.id }}" 
                                                               id="opcion_{{ pregunta.id }}_{{ opcion.id }}"
                                                               value="{{ opcion.id }}"
                                                               {% if pregunta.id in respuestas_existentes and respuestas_existentes.pregunta.id.opcion_seleccionada.id == opcion.id %}checked{% endif %}>
                                                        <label class="btn btn-outline-primary w-100 quiz-option text-start" 
                                                               for="opcion_{{ pregunta.id }}_{{ opcion.id }}">
                                                            <div class="d-flex align-items-center">
                                                                <span class="me-3 fw-bold">{{ forloop.counter|upper_alpha }}.</span>
                                                                <span>{{ opcion.texto }}</span>
                                                            </div>
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                
                                                {% elif pregunta.tipo.nombre == 'opcion_multiple' %}
                                                <!-- PREGUNTA DE OPCIÓN MÚLTIPLE -->
                                                <div class="vstack gap-2">
                                                    {% for opcion in pregunta.opciones.all %}
                                                    <div>
                                                        <input type="checkbox" class="btn-check" 
                                                               name="pregunta_{{ pregunta.id }}_multiple" 
                                                               id="opcion_{{ pregunta.id }}_{{ opcion.id }}"
                                                               value="{{ opcion.id }}"
                                                               {% if pregunta.id in respuestas_existentes and respuestas_existentes.pregunta.id.opcion_seleccionada.id == opcion.id %}checked{% endif %}>
                                                        <label class="btn btn-outline-primary w-100 quiz-option text-start" 
                                                               for="opcion_{{ pregunta.id }}_{{ opcion.id }}">
                                                            <div class="d-flex align-items-center">
                                                                <span class="me-3 fw-bold">{{ forloop.counter|upper_alpha }}.</span>
                                                                <span>{{ opcion.texto }}</span>
                                                            </div>
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <small class="text-muted mt-2">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Puedes seleccionar múltiples opciones
                                                </small>
                                                
                                                {% elif pregunta.tipo.nombre == 'respuesta_abierta' %}
                                                <!-- PREGUNTA DE RESPUESTA ABIERTA -->
                                                <div class="mb-3">
                                                    <label for="respuesta_{{ pregunta.id }}" class="form-label">
                                                        Tu respuesta:
                                                    </label>
                                                    <textarea class="form-control textarea-respuesta" 
                                                              id="respuesta_{{ pregunta.id }}"
                                                              name="pregunta_{{ pregunta.id }}_texto"
                                                              placeholder="Escribe tu respuesta aquí..."
                                                              {% if pregunta.longitud_minima %}minlength="{{ pregunta.longitud_minima }}"{% endif %}
                                                              {% if pregunta.longitud_maxima %}maxlength="{{ pregunta.longitud_maxima }}"{% endif %}>{% if respuestas_existentes|get_item:pregunta.id %}{{ respuestas_existentes|get_item:pregunta.id.respuesta_texto }}{% endif %}</textarea>
                                                    
                                                    <!-- Contador de caracteres -->
                                                    <div class="d-flex justify-content-between mt-2">
                                                        <small class="text-muted">
                                                            {% if pregunta.longitud_minima %}
                                                                Mínimo {{ pregunta.longitud_minima }} caracteres
                                                            {% endif %}
                                                        </small>
                                                        <small class="text-muted">
                                                            <span id="charCount_{{ pregunta.id }}">0</span>
                                                            {% if pregunta.longitud_maxima %} / {{ pregunta.longitud_maxima }}{% endif %} caracteres
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Criterios de evaluación si existen -->
                                                {% if pregunta.criterios_evaluacion %}
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-list-check me-2"></i>Criterios de evaluación:</h6>
                                                    <p class="mb-0">{{ pregunta.criterios_evaluacion }}</p>
                                                </div>
                                                {% endif %}
                                                
                                                {% elif pregunta.tipo.nombre == 'completar' %}
                                                <!-- PREGUNTA DE COMPLETAR TEXTO -->
                                                <div class="mb-3">
                                                    <div class="completar-container">
                                                        {% if pregunta.texto_completar %}
                                                            <!-- Aquí se renderizará el texto con espacios en blanco -->
                                                            <div id="textoCompletar_{{ pregunta.id }}" class="fs-5 lh-lg">
                                                                {{ pregunta.texto_completar|safe }}
                                                            </div>
                                                        {% else %}
                                                            <p class="text-muted">Completa los espacios en blanco:</p>
                                                            {% for i in "12345"|make_list %}
                                                            <div class="mb-3">
                                                                <label class="form-label">Respuesta {{ forloop.counter }}:</label>
                                                                <input type="text" class="form-control completar-input" 
                                                                       name="completar_{{ pregunta.id }}_{{ forloop.counter }}"
                                                                       placeholder="Tu respuesta...">
                                                            </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- Configuraciones -->
                                                    {% if pregunta.sensible_mayusculas %}
                                                    <small class="text-warning d-block mt-2">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        Las respuestas son sensibles a mayúsculas y minúsculas
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                
                                                {% elif pregunta.tipo.nombre == 'unir_lineas' %}
                                                <!-- PREGUNTA DE UNIR LÍNEAS -->
                                                <div class="row">
                                                    <div class="col-md-5">
                                                        <h6 class="text-primary mb-3">Columna A</h6>
                                                        <div class="list-group" id="columnaIzquierda_{{ pregunta.id }}">
                                                            {% if pregunta.columna_izquierda %}
                                                                {% for item in pregunta.columna_izquierda|linebreaks %}
                                                                <div class="list-group-item list-group-item-action draggable-item" 
                                                                     data-value="{{ forloop.counter }}"
                                                                     draggable="true">
                                                                    <strong>{{ forloop.counter }}.</strong> {{ item|striptags }}
                                                                </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-2 text-center">
                                                        <div class="mt-5 pt-3">
                                                            <i class="fas fa-arrows-alt-h fa-2x text-muted"></i>
                                                            <p class="small text-muted mt-2">Arrastra para conectar</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-5">
                                                        <h6 class="text-success mb-3">Columna B</h6>
                                                        <div class="list-group" id="columnaDerecha_{{ pregunta.id }}">
                                                            {% if pregunta.columna_derecha %}
                                                                {% for item in pregunta.columna_derecha|linebreaks %}
                                                                <div class="list-group-item list-group-item-action drop-zone" 
                                                                     data-value="{{ forloop.counter|upper_alpha }}">
                                                                    <strong>{{ forloop.counter|upper_alpha }}.</strong> {{ item|striptags }}
                                                                </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Área de conexiones realizadas -->
                                                <div class="mt-4">
                                                    <h6>Conexiones realizadas:</h6>
                                                    <div id="conexionesRealizadas_{{ pregunta.id }}" class="alert alert-light">
                                                        <p class="text-muted mb-0">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            Arrastra elementos de la Columna A hacia la Columna B para crear conexiones
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                {% elif pregunta.tipo.nombre == 'simulador_2d' or pregunta.tipo.nombre == 'simulador_3d' %}
                                                <!-- PREGUNTA DE SIMULADOR MOLECULAR -->
                                                <div class="mb-4">
                                                    <!-- Información del objetivo -->
                                                    {% if pregunta.descripcion_molecula %}
                                                    <div class="alert alert-info">
                                                        <h6><i class="fas fa-bullseye me-2"></i>Objetivo:</h6>
                                                        <p class="mb-0">{{ pregunta.descripcion_molecula }}</p>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <!-- Editor molecular -->
                                                    <div class="molecular-editor" id="molecularEditor_{{ pregunta.id }}">
                                                        <div class="text-center">
                                                            <i class="fas fa-atom fa-3x text-muted mb-3"></i>
                                                            <h5 class="text-muted">Editor Molecular {{ pregunta.tipo.nombre|upper }}</h5>
                                                            <p class="text-muted mb-3">
                                                                {% if pregunta.tipo.nombre == 'simulador_2d' %}
                                                                Dibuja la molécula en 2D usando el editor JSME
                                                                {% else %}
                                                                Construye la molécula en 3D usando el editor molecular
                                                                {% endif %}
                                                            </p>
                                                            <button type="button" class="btn btn-primary" 
                                                                    onclick="abrirEditorMolecular({{ pregunta.id }}, '{{ pregunta.tipo.nombre }}')">
                                                                <i class="fas fa-play me-2"></i>Abrir Editor
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Área de respuesta SMILES -->
                                                    <div class="mt-3">
                                                        <label for="smiles_{{ pregunta.id }}" class="form-label">
                                                            Código SMILES de tu molécula:
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" 
                                                                   id="smiles_{{ pregunta.id }}"
                                                                   name="pregunta_{{ pregunta.id }}_smiles"
                                                                   placeholder="Se generará automáticamente..."
                                                                   readonly
                                                                   value="{% if respuestas_existentes|get_item:pregunta.id %}{{ respuestas_existentes|get_item:pregunta.id.respuesta_smiles }}{% endif %}">
                                                            <button class="btn btn-outline-secondary" type="button" 
                                                                    onclick="validarMolecula({{ pregunta.id }})">
                                                                <i class="fas fa-check me-1"></i>Validar
                                                            </button>
                                                        </div>
                                                        <small class="text-muted">
                                                            El código SMILES se genera automáticamente al crear la molécula
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                {% else %}
                                                <!-- TIPO DE PREGUNTA NO RECONOCIDO -->
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    <strong>Tipo de pregunta no soportado:</strong> {{ pregunta.tipo.nombre }}
                                                </div>
                                                {% endif %}

                                                <!-- Navigation buttons -->
                                                <div class="d-flex justify-content-between mt-4">
                                                    <div>
                                                        {% if not forloop.first %}
                                                        <button type="button" class="btn btn-outline-secondary nav-quiz-btn" 
                                                                onclick="previousQuestion()">
                                                            <i class="fas fa-chevron-left me-2"></i>Anterior
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="text-center">
                                                        <button type="button" class="btn btn-outline-info" 
                                                                onclick="marcarParaRevision({{ pregunta.id }})">
                                                            <i class="fas fa-flag me-1"></i>Marcar para revisar
                                                        </button>
                                                    </div>
                                                    
                                                    <div>
                                                        {% if forloop.last %}
                                                        <button type="button" class="btn btn-success nav-quiz-btn" 
                                                                onclick="finalizarCuestionario()">
                                                            <i class="fas fa-check me-2"></i>Finalizar
                                                        </button>
                                                        {% else %}
                                                        <button type="button" class="btn btn-primary nav-quiz-btn" 
                                                                onclick="nextQuestion()">
                                                            Siguiente<i class="fas fa-chevron-right ms-2"></i>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                         
                                            </div>
                                            <!-- Pregunta {{ forloop.counter }} content END -->
                                            {% endfor %}

                                        </form>
                                    </div>
                                    <!-- Step content END -->
                                </div>
                                <!-- Card body END -->
                            </div>
                        </div>		
                    </div>
                
                </div>
                <!-- Course item END -->

            </div>
            <!-- Main content END -->
        </div> <!-- Row END -->
    </div>	
</section>
<!-- =======================
Page content END -->
</main>
<!-- **************** MAIN CONTENT END **************** -->

<!-- Modal de Confirmación para Salir START -->
<div class="modal fade" id="modalConfirmarSalir" tabindex="-1" aria-labelledby="modalSalirLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalSalirLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>¿Salir del Cuestionario?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-sign-out-alt text-danger mb-3" style="font-size: 3rem;"></i>
                    <h6>⚠️ ¿Estás seguro de que quieres salir?</h6>
                    <div class="alert alert-warning mt-3">
                        <ul class="mb-0 text-start">
                            <li>Tus respuestas han sido guardadas automáticamente</li>
                            <li>Podrás continuar desde donde lo dejaste</li>
                            <li>El tiempo seguirá corriendo aunque salgas</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <a href="{% url 'biblioteca_cuestionarios_estudiante' %}" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Sí, Salir
                </a>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Confirmación para Salir END -->

<!-- Modal de Finalizar Cuestionario START -->
<div class="modal fade" id="modalFinalizarCuestionario" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalFinalizarLabel">
                    <i class="fas fa-flag-checkered me-2"></i>Finalizar Cuestionario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                    <h4>¿Listo para enviar tu cuestionario?</h4>
                </div>
                
                <!-- Resumen de respuestas -->
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded">
                            <h3 class="text-success mb-0" id="resumenRespondidas">0</h3>
                            <small class="text-muted">Respondidas</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded">
                            <h3 class="text-warning mb-0" id="resumenMarcadas">0</h3>
                            <small class="text-muted">Marcadas</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light p-3 rounded">
                            <h3 class="text-danger mb-0" id="resumenSinResponder">0</h3>
                            <small class="text-muted">Sin responder</small>
                        </div>
                    </div>
                </div>
                
                <!-- Advertencias -->
                <div class="mt-4" id="advertenciasFinalizacion">
                    <!-- Se llena dinámicamente con JavaScript -->
                </div>
                
                <!-- Tiempo utilizado -->
                <div class="alert alert-info mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <strong>Tiempo utilizado:</strong>
                            <br><span id="tiempoUtilizado">--</span>
                        </div>
                        <div class="col-6">
                            <strong>Tiempo restante:</strong>
                            <br><span id="tiempoRestanteFinal">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i>Seguir Respondiendo
                </button>
                <button type="button" class="btn btn-success" onclick="enviarCuestionario()">
                    <i class="fas fa-paper-plane me-1"></i>Enviar Cuestionario
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Finalizar Cuestionario END -->

<!-- Modal de Resumen de Respuestas START -->
<div class="modal fade" id="modalResumenRespuestas" tabindex="-1" aria-labelledby="modalResumenLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalResumenLabel">
                    <i class="fas fa-list-check me-2"></i>Resumen de Respuestas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resumenRespuestasContent">
                <!-- Se llena dinámicamente con JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="irAPreguntaSinResponder()">
                    <i class="fas fa-arrow-right me-1"></i>Ir a Primera Sin Responder
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Resumen de Respuestas END -->

<!-- Modal de Instrucciones START -->
<div class="modal fade" id="modalInstrucciones" tabindex="-1" aria-labelledby="modalInstruccionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalInstruccionesLabel">
                    <i class="fas fa-info-circle me-2"></i>Instrucciones del Cuestionario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6 class="text-primary">📋 Instrucciones Específicas:</h6>
                    <div class="bg-light p-3 rounded">
                        {{ cuestionario.instrucciones|linebreaks }}
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6 class="text-success">✅ Instrucciones Generales:</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <i class="fas fa-clock text-warning me-2"></i>
                            Tienes <strong>{{ cuestionario.tiempo_limite }} minutos</strong> para completar el cuestionario
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-save text-success me-2"></i>
                            Tus respuestas se <strong>guardan automáticamente</strong> mientras respondes
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-arrows-alt text-info me-2"></i>
                            Puedes <strong>navegar libremente</strong> entre las preguntas
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-flag text-warning me-2"></i>
                            Puedes <strong>marcar preguntas para revisar</strong> más tarde
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-paper-plane text-primary me-2"></i>
                            Recuerda <strong>finalizar y enviar</strong> tu cuestionario antes de que se acabe el tiempo
                        </li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Importante:</strong> Una vez enviado el cuestionario, no podrás modificar tus respuestas.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-1"></i>Entendido
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Instrucciones END -->

<!-- Modal de Editor Molecular START -->
<div class="modal fade" id="modalEditorMolecular" tabindex="-1" aria-labelledby="modalEditorLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalEditorLabel">
                    <i class="fas fa-atom me-2"></i>Editor Molecular
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="editorMolecularContainer" style="width: 100%; height: 80vh;">
                    <!-- Aquí se cargará el editor molecular -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="guardarMolecula()">
                    <i class="fas fa-save me-1"></i>Guardar Molécula
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Editor Molecular END -->

<!-- =======================
Footer START -->
<footer class="bg-dark p-3">
    <div class="container">
        <div class="row align-items-center">
            <!-- Widget -->
            <div class="col-md-4 text-center text-md-start mb-3 mb-md-0">
                <!-- Logo START -->
                <a href="{% url 'inicio' %}"> 
                    <img class="h-20px" src="{% static 'assets/images/logo-light.svg' %}" alt="logo"> 
                </a>
            </div>
            
            <!-- Widget -->
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="text-center text-white text-primary-hover">
                    Cuestionario en progreso - {{ cuestionario.recurso.titulo }}
                </div>
            </div>
            <!-- Widget -->
            <div class="col-md-4">
                <!-- Contact info -->
                <div class="text-center text-md-end">
                    <small class="text-white">
                        <i class="fas fa-shield-alt me-1"></i>
                        Conexión segura • Auto-guardado activo
                    </small>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- =======================
Footer END -->

<!-- Back to top -->
<div class="back-top"><i class="bi bi-arrow-up-short position-absolute top-50 start-50 translate-middle"></i></div>

<!-- Bootstrap JS -->
<script src="{% static 'assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>

<!-- Vendors -->
<script src="{% static 'assets/vendor/stepper/js/bs-stepper.min.js' %}"></script>

<!-- Template Functions -->
<script src="{% static 'assets/js/functions.js' %}"></script>

<!-- JSME Molecular Editor (para simuladores 2D) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsme/2017-03-01/jsme.nocache.js"></script>

<!-- JavaScript para el Cuestionario -->
<script>
// =====================================================
// VARIABLES GLOBALES
// =====================================================
let currentQuestionIndex = 1;
let totalQuestions = {{ preguntas.count }};
let timeLeft = {{ tiempo_restante }}; // en segundos
let quizTimer;
let stepper;
let isSubmitting = false;
let answeredQuestions = new Set();
let markedQuestions = new Set();
let autoSaveTimeout;

// Datos del cuestionario
const quizData = {
    intentoId: {{ intento.id }},
    cuestionarioId: {{ cuestionario.id }},
    tiempoLimite: {{ cuestionario.tiempo_limite }},
    totalPreguntas: {{ preguntas.count }},
    preguntasData: [
        {% for pregunta in preguntas %}
        {
            id: {{ pregunta.id }},
            numero: {{ forloop.counter }},
            tipo: '{{ pregunta.tipo.nombre }}',
            puntaje: {{ pregunta.puntaje }},
            {% if respuestas_existentes|get_item:pregunta.id %}
            tieneRespuesta: true,
            {% else %}
            tieneRespuesta: false,
            {% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
};

// =====================================================
// INICIALIZACIÓN
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Inicializando cuestionario...');
    
    // Inicializar stepper
    stepper = new Stepper(document.querySelector('#stepper'), {
        linear: false,
        animation: true
    });
    
    // Configurar timer
    initTimer();
    
    // Configurar auto-guardado
    setupAutoSave();
    
    // Configurar navegación
    setupNavigation();
    
    // Configurar contadores de caracteres
    setupCharCounters();
    
    // Inicializar estado de preguntas
    initQuestionsState();
    
    // Configurar drag and drop para unir líneas
    setupDragAndDrop();
    
    // Prevenir salida accidental
    setupBeforeUnload();
    
    console.log('✅ Cuestionario inicializado correctamente');
});

// =====================================================
// GESTIÓN DE TIMER
// =====================================================
function initTimer() {
    updateTimerDisplay();
    
    quizTimer = setInterval(function() {
        timeLeft--;
        updateTimerDisplay();
        
        // Advertencias de tiempo
        if (timeLeft <= 300 && timeLeft > 60) { // 5 minutos
            document.getElementById('timerCard').classList.add('timer-warning');
        } else if (timeLeft <= 60 && timeLeft > 0) { // 1 minuto
            document.getElementById('timerCard').classList.add('timer-critical');
        } else if (timeLeft <= 0) {
            // Tiempo agotado
            clearInterval(quizTimer);
            autoSubmitQuiz();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Actualizar displays del timer
    const timeLeftSpan = document.getElementById('timeLeft');
    const mobileTimeLeft = document.getElementById('mobileTimeLeft');
    
    if (timeLeftSpan) timeLeftSpan.textContent = display;
    if (mobileTimeLeft) mobileTimeLeft.textContent = display;
}

function autoSubmitQuiz() {
    if (!isSubmitting) {
        alert('⏰ Se acabó el tiempo. El cuestionario se enviará automáticamente.');
        enviarCuestionario(true);
    }
}

// =====================================================
// NAVEGACIÓN ENTRE PREGUNTAS
// =====================================================
function goToQuestion(questionNumber) {
    if (questionNumber < 1 || questionNumber > totalQuestions) return;
    
    // Guardar respuesta actual antes de cambiar
    saveCurrentAnswer();
    
    // Ocultar pregunta actual
    const currentStep = document.querySelector(`#step-${currentQuestionIndex}`);
    if (currentStep) {
        currentStep.classList.remove('active', 'show');
    }
    
    // Mostrar nueva pregunta
    const newStep = document.querySelector(`#step-${questionNumber}`);
    if (newStep) {
        newStep.classList.add('active', 'show');
    }
    
    // Actualizar stepper
    stepper.to(questionNumber - 1);
    
    // Actualizar índice actual
    currentQuestionIndex = questionNumber;
    
    // Actualizar displays
    updateQuestionCounters();
    updateProgress();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log(`📍 Navegando a pregunta ${questionNumber}`);
}

function nextQuestion() {
    if (currentQuestionIndex < totalQuestions) {
        goToQuestion(currentQuestionIndex + 1);
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 1) {
        goToQuestion(currentQuestionIndex - 1);
    }
}

function updateQuestionCounters() {
    // Actualizar contadores
    const currentQuestionSpans = document.querySelectorAll('#currentQuestion, #mobileCurrentQuestion');
    currentQuestionSpans.forEach(span => {
        span.textContent = currentQuestionIndex;
    });
}

// =====================================================
// AUTO-GUARDADO DE RESPUESTAS
// =====================================================
function setupAutoSave() {
    // Configurar listeners para diferentes tipos de preguntas
    
    // Radio buttons y checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.type === 'radio' || e.target.type === 'checkbox') {
            debouncedSave();
        }
    });
    
    // Text areas y inputs
    document.addEventListener('input', function(e) {
        if (e.target.tagName === 'TEXTAREA' || 
            (e.target.tagName === 'INPUT' && e.target.type === 'text')) {
            debouncedSave();
            
            // Actualizar contador de caracteres si existe
            updateCharCounter(e.target);
        }
    });
}

function debouncedSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        saveCurrentAnswer();
    }, 1000); // Guardar después de 1 segundo de inactividad
}

function saveCurrentAnswer() {
    const currentStep = document.querySelector(`#step-${currentQuestionIndex}`);
    if (!currentStep) return;
    
    const questionId = currentStep.dataset.questionId;
    const questionType = currentStep.dataset.questionType;
    
    let respuestaData = {
        intento_id: quizData.intentoId,
        pregunta_id: questionId,
        tipo: questionType
    };
    
    // Recopilar respuesta según el tipo
    switch(questionType) {
        case 'opcion_unica':
        case 'falso_verdadero':
            const selectedRadio = currentStep.querySelector(`input[name="pregunta_${questionId}"]:checked`);
            if (selectedRadio) {
                respuestaData.respuesta = selectedRadio.value;
            }
            break;
            
        case 'opcion_multiple':
            const selectedCheckboxes = currentStep.querySelectorAll(`input[name="pregunta_${questionId}_multiple"]:checked`);
            if (selectedCheckboxes.length > 0) {
                respuestaData.respuesta = Array.from(selectedCheckboxes).map(cb => cb.value);
            }
            break;
            
        case 'respuesta_abierta':
            const textarea = currentStep.querySelector(`textarea[name="pregunta_${questionId}_texto"]`);
            if (textarea && textarea.value.trim()) {
                respuestaData.respuesta = textarea.value.trim();
            }
            break;
            
        case 'completar':
            const completarInputs = currentStep.querySelectorAll('.completar-input');
            const completarRespuestas = Array.from(completarInputs).map(input => input.value).join('|');
            if (completarRespuestas) {
                respuestaData.respuesta = completarRespuestas;
            }
            break;
            
        case 'unir_lineas':
            // Implementar lógica para unir líneas
            const conexiones = getConexionesRealizadas(questionId);
            if (Object.keys(conexiones).length > 0) {
                respuestaData.respuesta = conexiones;
            }
            break;
            
        case 'simulador_2d':
        case 'simulador_3d':
            const smilesInput = currentStep.querySelector(`input[name="pregunta_${questionId}_smiles"]`);
            if (smilesInput && smilesInput.value.trim()) {
                respuestaData.respuesta = smilesInput.value.trim();
            }
            break;
    }
    
    // Enviar si hay respuesta
    if (respuestaData.respuesta !== undefined) {
        sendAnswerToServer(respuestaData);
    }
}

function sendAnswerToServer(respuestaData) {
    // Mostrar indicador de guardado
    showSaveIndicator('saving');
    
    fetch('{% url "guardar_respuesta" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(respuestaData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSaveIndicator('saved');
            
            // Marcar pregunta como respondida
            const questionNum = getCurrentQuestionNumber(respuestaData.pregunta_id);
            answeredQuestions.add(questionNum);
            updateQuestionNavigation();
            updateProgress();
            
            console.log('✅ Respuesta guardada exitosamente');
        } else {
            showSaveIndicator('error');
            console.error('❌ Error al guardar respuesta:', data.error);
        }
    })
    .catch(error => {
        showSaveIndicator('error');
        console.error('❌ Error de red al guardar respuesta:', error);
    });
}

function showSaveIndicator(status) {
    const indicator = document.getElementById('saveIndicator');
    const statusSpan = document.getElementById('autosaveStatus');
    
    indicator.classList.remove('show');
    
    setTimeout(() => {
        switch(status) {
            case 'saving':
                indicator.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i><span>Guardando...</span>';
                indicator.style.background = '#ffc107';
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i><span>Guardando...</span>';
                    statusSpan.className = 'autosave-status saving';
                }
                break;
            case 'saved':
                indicator.innerHTML = '<i class="fas fa-check me-2"></i><span>Guardado</span>';
                indicator.style.background = '#28a745';
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="fas fa-check me-1"></i><span>Guardado</span>';
                    statusSpan.className = 'autosave-status saved';
                }
                break;
            case 'error':
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span>Error al guardar</span>';
                indicator.style.background = '#dc3545';
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i><span>Error</span>';
                    statusSpan.className = 'autosave-status';
                }
                break;
        }
        
        indicator.classList.add('show');
        
        // Ocultar después de 3 segundos si no es error
        if (status !== 'error') {
            setTimeout(() => {
                indicator.classList.remove('show');
                if (statusSpan && status === 'saved') {
                    setTimeout(() => {
                        statusSpan.innerHTML = '<i class="fas fa-sync-alt me-1"></i><span>Auto-guardado activo</span>';
                        statusSpan.className = 'autosave-status';
                    }, 500);
                }
            }, 3000);
        }
    }, 100);
}

// =====================================================
// PROGRESO Y NAVEGACIÓN VISUAL
// =====================================================
function updateProgress() {
    const answered = answeredQuestions.size;
    const percentage = (answered / totalQuestions) * 100;
    
    // Actualizar barra de progreso
    const progressBar = document.getElementById('globalProgress');
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }
    
    // Actualizar contador
    const answeredCount = document.getElementById('answeredCount');
    if (answeredCount) {
        answeredCount.textContent = answered;
    }
}

function updateQuestionNavigation() {
    const questionButtons = document.querySelectorAll('.question-nav-btn');
    
    questionButtons.forEach((btn, index) => {
        const questionNum = index + 1;
        btn.classList.remove('btn-outline-light', 'btn-success', 'btn-primary');
        
        if (questionNum === currentQuestionIndex) {
            btn.classList.add('btn-primary');
        } else if (answeredQuestions.has(questionNum)) {
            btn.classList.add('btn-success');
        } else {
            btn.classList.add('btn-outline-light');
        }
    });
}

function initQuestionsState() {
    // Inicializar estado basado en respuestas existentes
    quizData.preguntasData.forEach(pregunta => {
        if (pregunta.tieneRespuesta) {
            answeredQuestions.add(pregunta.numero);
        }
    });
    
    updateProgress();
    updateQuestionNavigation();
}

// =====================================================
// CONTADORES DE CARACTERES
// =====================================================
function setupCharCounters() {
    document.querySelectorAll('textarea').forEach(textarea => {
        const preguntaId = textarea.name.match(/pregunta_(\d+)_texto/);
        if (preguntaId) {
            const countSpan = document.getElementById(`charCount_${preguntaId[1]}`);
            if (countSpan) {
                updateCharCounter(textarea);
            }
        }
    });
}

function updateCharCounter(element) {
    const preguntaId = element.name.match(/pregunta_(\d+)_texto/);
    if (!preguntaId) return;
    
    const countSpan = document.getElementById(`charCount_${preguntaId[1]}`);
    if (countSpan) {
        countSpan.textContent = element.value.length;
        
        // Cambiar color basado en límites
        const minLength = element.getAttribute('minlength');
        const maxLength = element.getAttribute('maxlength');
        
        if (minLength && element.value.length < parseInt(minLength)) {
            countSpan.style.color = '#dc3545'; // Rojo
        } else if (maxLength && element.value.length > parseInt(maxLength) * 0.9) {
            countSpan.style.color = '#ffc107'; // Amarillo
        } else {
            countSpan.style.color = '#28a745'; // Verde
        }
    }
}

// =====================================================
// DRAG AND DROP PARA UNIR LÍNEAS
// =====================================================
function setupDragAndDrop() {
    // Implementar drag and drop para preguntas de unir líneas
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });
    
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleDrop);
        zone.addEventListener('dragenter', handleDragEnter);
        zone.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.value);
    e.target.style.opacity = '0.5';
}

function handleDragEnd(e) {
    e.target.style.opacity = '1';
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDragEnter(e) {
    e.preventDefault();
    e.target.classList.add('bg-light');
}

function handleDragLeave(e) {
    e.target.classList.remove('bg-light');
}

function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('bg-light');
    
    const draggedValue = e.dataTransfer.getData('text/plain');
    const dropValue = e.target.dataset.value;
    
    // Guardar conexión
    saveConnection(draggedValue, dropValue);
}

function saveConnection(from, to) {
    // Implementar guardado de conexión
    console.log(`Conexión: ${from} -> ${to}`);
}

function getConexionesRealizadas(questionId) {
    // Implementar obtención de conexiones realizadas
    return {};
}

// =====================================================
// FUNCIONES DE UTILIDAD
// =====================================================
function getCurrentQuestionNumber(questionId) {
    const pregunta = quizData.preguntasData.find(p => p.id == questionId);
    return pregunta ? pregunta.numero : 0;
}

function setupNavigation() {
    // Configurar botones de navegación
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('next-btn') || e.target.closest('.next-btn')) {
            nextQuestion();
        }
    });
    
    // Configurar navegación por teclado
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousQuestion();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextQuestion();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (currentQuestionIndex === totalQuestions) {
                        finalizarCuestionario();
                    } else {
                        nextQuestion();
                    }
                    break;
            }
        }
    });
}

function setupBeforeUnload() {
    window.addEventListener('beforeunload', function(e) {
        if (!isSubmitting) {
            e.preventDefault();
            e.returnValue = '¿Estás seguro de que quieres salir? Tu progreso se ha guardado automáticamente.';
            return e.returnValue;
        }
    });
}

// =====================================================
// FUNCIONES PARA MODALES Y ACCIONES
// =====================================================
function confirmarSalir() {
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmarSalir'));
    modal.show();
}

function finalizarCuestionario() {
    // Actualizar resumen
    actualizarResumenFinal();
    
    const modal = new bootstrap.Modal(document.getElementById('modalFinalizarCuestionario'));
    modal.show();
}

function actualizarResumenFinal() {
    const respondidas = answeredQuestions.size;
    const marcadas = markedQuestions.size;
    const sinResponder = totalQuestions - respondidas;
    
    document.getElementById('resumenRespondidas').textContent = respondidas;
    document.getElementById('resumenMarcadas').textContent = marcadas;
    document.getElementById('resumenSinResponder').textContent = sinResponder;
    
    // Calcular tiempo utilizado
    const tiempoTotal = quizData.tiempoLimite * 60; // en segundos
    const tiempoUtilizado = tiempoTotal - timeLeft;
    const minutosUtilizados = Math.floor(tiempoUtilizado / 60);
    const segundosUtilizados = tiempoUtilizado % 60;
    
    document.getElementById('tiempoUtilizado').textContent = 
        `${minutosUtilizados}:${segundosUtilizados.toString().padStart(2, '0')}`;
    
    const minutosRestantes = Math.floor(timeLeft / 60);
    const segundosRestantes = timeLeft % 60;
    document.getElementById('tiempoRestanteFinal').textContent = 
        `${minutosRestantes}:${segundosRestantes.toString().padStart(2, '0')}`;
    
    // Mostrar advertencias si hay preguntas sin responder
    const advertenciasDiv = document.getElementById('advertenciasFinalizacion');
    if (sinResponder > 0) {
        advertenciasDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Atención:</strong> Tienes ${sinResponder} pregunta${sinResponder !== 1 ? 's' : ''} sin responder.
                ¿Estás seguro de que quieres finalizar?
            </div>
        `;
    } else {
        advertenciasDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>¡Excelente!</strong> Has respondido todas las preguntas.
            </div>
        `;
    }
}

function enviarCuestionario(timeUp = false) {
    if (isSubmitting) return;
    
    isSubmitting = true;
    clearInterval(quizTimer);
    
    // Mostrar loading
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Guardar respuesta actual
    saveCurrentAnswer();
    
    // Esperar un poco para que se guarde la última respuesta
    setTimeout(() => {
        window.location.href = `{% url 'finalizar_cuestionario_estudiante' intento.id %}`;
    }, 1000);
}

function mostrarResumen() {
    // Generar resumen de respuestas
    let resumenHTML = '<div class="row">';
    
    quizData.preguntasData.forEach((pregunta, index) => {
        const respondida = answeredQuestions.has(pregunta.numero);
        const marcada = markedQuestions.has(pregunta.numero);
        
        resumenHTML += `
            <div class="col-md-6 mb-3">
                <div class="card ${respondida ? 'border-success' : 'border-warning'}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Pregunta ${pregunta.numero}</h6>
                                <small class="text-muted">${pregunta.tipo} • ${pregunta.puntaje} pts</small>
                            </div>
                            <div>
                                ${respondida ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-clock text-warning"></i>'}
                                ${marcada ? '<i class="fas fa-flag text-info ms-1"></i>' : ''}
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="goToQuestion(${pregunta.numero}); bootstrap.Modal.getInstance(document.getElementById('modalResumenRespuestas')).hide();">
                                <i class="fas fa-arrow-right me-1"></i>Ir a pregunta
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    resumenHTML += '</div>';
    
    document.getElementById('resumenRespuestasContent').innerHTML = resumenHTML;
    
    const modal = new bootstrap.Modal(document.getElementById('modalResumenRespuestas'));
    modal.show();
}

function verInstrucciones() {
    const modal = new bootstrap.Modal(document.getElementById('modalInstrucciones'));
    modal.show();
}

function marcarParaRevision(questionId = null) {
    const questionNum = questionId ? getCurrentQuestionNumber(questionId) : currentQuestionIndex;
    
    if (markedQuestions.has(questionNum)) {
        markedQuestions.delete(questionNum);
        console.log(`🏴 Desmarcada pregunta ${questionNum}`);
    } else {
        markedQuestions.add(questionNum);
        console.log(`🏁 Marcada pregunta ${questionNum} para revisión`);
    }
    
    updateQuestionNavigation();
}

function guardarBorrador() {
    saveCurrentAnswer();
    alert('📝 Borrador guardado. Tu progreso está seguro.');
}

function irAPreguntaSinResponder() {
    for (let i = 1; i <= totalQuestions; i++) {
        if (!answeredQuestions.has(i)) {
            goToQuestion(i);
            break;
        }
    }
}

// =====================================================
// EDITOR MOLECULAR
// =====================================================
function abrirEditorMolecular(questionId, tipo) {
    console.log(`🧪 Abriendo editor molecular para pregunta ${questionId} (${tipo})`);
    
    const modal = new bootstrap.Modal(document.getElementById('modalEditorMolecular'));
    modal.show();
    
    // Aquí se inicializaría el editor molecular específico
    // Por ahora, simulamos la funcionalidad
    setTimeout(() => {
        document.getElementById('editorMolecularContainer').innerHTML = `
            <div class="text-center p-5">
                <i class="fas fa-atom fa-4x text-primary mb-4"></i>
                <h4>Editor Molecular ${tipo.toUpperCase()}</h4>
                <p class="text-muted mb-4">Aquí se cargaría el editor molecular específico</p>
                <div class="alert alert-info">
                    <strong>En desarrollo:</strong> La integración completa del editor molecular estará disponible próximamente.
                </div>
                <button class="btn btn-primary" onclick="simularMolecula(${questionId})">
                    <i class="fas fa-flask me-2"></i>Simular Molécula de Ejemplo
                </button>
            </div>
        `;
    }, 100);
}

function simularMolecula(questionId) {
    // Simular generación de SMILES
    const ejemploSMILES = 'CCO'; // Etanol como ejemplo
    
    const smilesInput = document.getElementById(`smiles_${questionId}`);
    if (smilesInput) {
        smilesInput.value = ejemploSMILES;
        
        // Activar auto-guardado
        debouncedSave();
        
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalEditorMolecular')).hide();
        
        alert('🧪 Molécula de ejemplo generada: Etanol (CCO)');
    }
}

function guardarMolecula() {
    // Implementar guardado de molécula desde el editor
    bootstrap.Modal.getInstance(document.getElementById('modalEditorMolecular')).hide();
}

function validarMolecula(questionId) {
    const smilesInput = document.getElementById(`smiles_${questionId}`);
    const smiles = smilesInput.value.trim();
    
    if (!smiles) {
        alert('⚠️ Primero debes crear una molécula');
        return;
    }
    
    // Simular validación
    alert(`✅ Molécula validada: ${smiles}`);
}

console.log('🎯 Sistema de cuestionarios cargado completamente');
</script>

</body>
</html>